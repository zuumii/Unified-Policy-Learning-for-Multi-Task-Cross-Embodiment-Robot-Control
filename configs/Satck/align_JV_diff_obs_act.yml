# =================== Align（Panda -> Sawyer）===================
env_name: Stack

env_kwargs:
  horizon: 300
  use_touch_obs: true
  table_offset: [0, 0, 0.908]
  gripper_types: PandaTouchGripper
  # gripper_types: Robotiq85TouchGripper

# -------- 源 / 目标域观测键（保持一致的 obj_obs 部分）--------
src_env:
  robot: Panda
  controller_type: JOINT_VELOCITY
  robot_obs_keys:
    - robot0_joint_pos_cos
    - robot0_joint_pos_sin
  obj_obs_keys:
    # - robot0_eef_pos
    # - robot0_eef_quat
    # - robot0_gripper_qpos
    # - robot0_gripper_qvel
    - robot0_touch
    - robot0_gripper_width
    # - cubeA_pos
    # - cubeA_quat
    # - cubeB_pos
    # - cubeB_quat
    - gripper_to_cubeA
    - gripper_to_cubeB
    - cubeA_to_cubeB
    - eef_to_cubeA_yaw
    # 可选（若用就别重复单项键）： object-state
    # - object-state

tgt_env:
  robot: Sawyer
  controller_type: JOINT_VELOCITY
  robot_obs_keys:
    - robot0_joint_pos_cos
    - robot0_joint_pos_sin
  obj_obs_keys:
    # - robot0_eef_pos
    # - robot0_eef_quat
    # - robot0_gripper_qpos
    # - robot0_gripper_qvel
    - robot0_touch
    - robot0_gripper_width
    # - cubeA_pos
    # - cubeA_quat
    # - cubeB_pos
    # - cubeB_quat
    - gripper_to_cubeA
    - gripper_to_cubeB
    - cubeA_to_cubeB
    - eef_to_cubeA_yaw
    # 可选（若用就别重复单项键）： object-state
    # - object-state


# -------- 数据与模型 --------
src_buffer: human_demonstrations/Stack/Panda/JOINT_VELOCITY
tgt_buffer: human_demonstrations/Stack/Sawyer/JOINT_VELOCITY

# 与源 TD3 模型保持一致（很关键）
lat_obs_dim: 6
lat_act_dim: 6

# 训练步数与批量
tgt_align_timesteps: 300001
batch_size: 4096

# 冷启动所需的源模型（从这里加载并冻结 E_src / D_src / dyn / actor 等）
src_model_dir: models/6/Stack/23-47-54_Stack_Panda_JOINT_VELOCITY_BC/models/step_1800000

# 其他常规项
seed: 42
save_buffer: false
logdir_prefix: null
log_freq: 1000

evaluation:
  interval: 2000
  episodes: 8
  save_interval: 20000


suffix: align_cycle

# =================== 续训（读取本脚本生成的 ckpt）===================
# - 只恢复“目标侧生成器 + 判别器 + 优化器”的训练态
# - 源侧模块依然从 src_model_dir 读取并冻结
resume:
  enabled: false
  # 可以指到 logs/.../models 或者直接指到某个 step_xxxxxx 目录
  dir: logs/09.25.2025/23-37-55_Reach_Panda_JOINT_VELOCITY_Sawyer_JOINT_VELOCITY_align_cycle/models/step_0028000

# =================== SEW（两预测器；无几何；生成器端）===================
# 只在生成器端加入两项：
#   1) 交叉一致（最重要）：σ_tgt(D_tgt(E_src(x_src))) ≈ σ_src(x_src)
#   2) 循环一致（辅助）：  σ_tgt(D_tgt(E_src(D_src(E_tgt(x_tgt))))) ≈ σ_tgt(x_tgt)
# 其中 teacher 分支 detach，student 分支保留梯度，梯度仅回流到目标侧生成器。
sew:
  enabled: false
  lambda: 5           # 总的 SEW 权重 
  ratio_cross: 1.5      # 交叉一致在 SEW 内部的占比（强烈建议高一些）
  ratio_self: 0.0       # 循环一致在 SEW 内部的占比
  every: 1              # 每几步计算一次 SEW；=1 表示每步
  max_batch: 4096       # 子采样上限；若想全批次训练 SEW，可配合 train_all:true
  train_all: true      # true 则忽略 max_batch/ every，步步全批次（更慢但最稳）

  # 源/目标域的 SEW 预测器（请改为你的实际权重路径）
  src_predictor:
    path: models/predictor/sew_predictor_UR5e.pt
    # 如小模型训练时做过标准化，可补充：
    # norm:
    #   mean: [ ... ]
    #   std:  [ ... ]

  tgt_predictor:
    path: models/predictor/sew_predictor_Panda.pt
    # norm:
    #   mean: [ ... ]
    #   std:  [ ... ]

# =================== 新增：Diffusion 先验（与 GAN 并存，可开关/加权）===================
# 先验来自你跑的 diffusion_pretrain 脚本；dir 指到那次日志目录
diffusion_priors:
  dir: logs/10.26.2025/10-16-13_Reach_Panda_JOINT_VELOCITY_Sawyer_JOINT_VELOCITY_diffusion_pretrain
  use_ema: true      # 对齐/训练时使用 *_ema.pt
  # t_embed: ddpm    # 可选，默认 ddpm（与你的预训练一致即可
  
diffusion_priors_act:
  dir: logs/10.26.2025/18-43-24_Reach_Panda_JOINT_VELOCITY_Sawyer_JOINT_VELOCITY_diffusion_pretrain_act
  use_ema: true

cond:
  keys:
    - robot0_eef_pos            # 以后可再加键，只要训练先验时也是同维度/顺序
  strict_dim_check: true        # 维度不匹配直接报错

cond_act:             # ← 给动作分支单独的条件键
  keys:
    - robot0_eef_pos 
    - target_to_robot0_eef_pos
  strict_dim_check: true

# 对齐损失的“总控”权重/开关（GAN 和 Diffusion 可以同时开）
align_loss:
  gan:
    enabled: false
    lambda:
      lat: 1.0
      src: 1.0
      tgt: 1.0
  diffusion:
    enabled: true          # ← 打开先验（如要只用 GAN，这里改 false）
    lambda:
      lat: 20.0             # z_tgt 对应的先验权重
      src: 20.0             # D_src(E_tgt(tgt)) 回到 src 观测空间的先验权重
      tgt: 20.0             # tgt 真实观测空间（最稳）的先验权重
  diffusion_act:
    enabled: true          # ← 打开先验（如要只用 GAN，这里改 false）
    lambda:
      lat: 20.0             # z_tgt 对应的先验权重
      src: 20.0             # D_src(E_tgt(tgt)) 回到 src 观测空间的先验权重
      tgt: 20.0 
 
 
    # 可选：覆盖预训练 schedule；不需要就 keep false
    schedule_override:
      use_override: false
      T: 128
      beta: cosine         # cosine | linear
      loss_weight: sigma2  # sigma2 | snr

  # 下面两项是原本的权重名，保持默认不变；仅把它们集中放到 align_loss 里更清晰（也可不写）
  cycle:
    lambda: 10.0
  dynamics:
    lambda: 20.0

# ===================（可选）优化/网络规模（若不写，脚本里用默认）===================
# n_layers: 3
# hidden_dim: 256
# lr: 3.0e-4
# lmbd_gp: 10
# sew_huber_delta: null